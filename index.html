<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® Yaadannoo - Your Emoji-Powered Notes</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="A beautiful, emoji-powered note-taking app that works offline. Organize your thoughts with tags, emojis, and rich text editing.">
    <meta name="theme-color" content="#4f46e5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Yaadannoo">
    <meta name="msapplication-TileColor" content="#4f46e5">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- PWA Manifest and Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-72x72.png">
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- App Styles -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- PWA Install Prompt -->
    <div id="install-prompt" class="install-prompt hidden">
        <div class="install-content">
            <div class="install-icon">
                <i class="fas fa-download"></i>
            </div>
            <div class="install-text">
                <h3>Install Yaadannoo</h3>
                <p>Get the full app experience! Install Yaadannoo for quick access and offline support.</p>
            </div>
            <div class="install-actions">
                <button id="install-button" class="btn primary install-btn">
                    <i class="fas fa-plus"></i> Install App
                </button>
                <button id="install-dismiss" class="btn secondary">
                    <i class="fas fa-times"></i> Maybe Later
                </button>
            </div>
        </div>
    </div>
    <div class="container">
        <header class="app-header">
            <div class="header-content">
                <h1><span class="sparkle">‚ú®</span> Yaadannoo</h1>
                <p class="tagline">Your thoughts, beautifully organized <span class="waving-hand">üëã</span></p>
            </div>
            
            <!-- Desktop Navigation -->
            <div class="desktop-navigation">
                <button id="nav-notes-desktop" class="nav-btn desktop-nav-btn" data-view="notes">
                    <i class="fas fa-sticky-note"></i>
                    <span>Notes</span>
                </button>
                <button id="nav-books-desktop" class="nav-btn desktop-nav-btn active" data-view="books">
                    <i class="fas fa-book"></i>
                    <span>Books</span>
                </button>
                <button id="nav-highlights-desktop" class="nav-btn desktop-nav-btn" data-view="highlights">
                    <i class="fas fa-highlighter"></i>
                    <span>Highlights</span>
                </button>
            </div>
            
            <div class="header-actions">
                <!-- Mobile Menu Button -->
                <button id="mobile-menu-btn" class="icon-btn mobile-menu-btn" title="Menu">
                    <i class="fas fa-bars"></i>
                </button>
                <!-- Desktop Actions -->
                <div class="desktop-actions">
                    <button id="theme-toggle" class="icon-btn" title="Change theme">
                        <i class="fas fa-sun"></i>
                    </button>
                    <button id="new-note-btn" class="icon-btn" title="New Note">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Mobile Sidebar Menu -->
        <div id="mobile-sidebar" class="mobile-sidebar">
            <div class="sidebar-header">
                <h3>‚ú® Yaadannoo</h3>
                <button id="close-sidebar-btn" class="icon-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <div class="sidebar-section">
                    <h4>üè† Main Navigation</h4>
                    <button id="nav-notes" class="sidebar-btn nav-btn" data-view="notes">
                        <i class="fas fa-sticky-note"></i> Notes
                    </button>
                    <button id="nav-books" class="sidebar-btn nav-btn active" data-view="books">
                        <i class="fas fa-book"></i> Books
                    </button>
                    <button id="nav-highlights" class="sidebar-btn nav-btn" data-view="highlights">
                        <i class="fas fa-highlighter"></i> Highlights
                    </button>
                </div>
                <div class="sidebar-section">
                    <h4>üìù Actions</h4>
                    <button id="sidebar-new-note" class="sidebar-btn">
                        <i class="fas fa-plus"></i> New Note
                    </button>
                    <button id="sidebar-new-book" class="sidebar-btn">
                        <i class="fas fa-book-open"></i> Add Book
                    </button>
                    <button id="sidebar-search" class="sidebar-btn">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                <div class="sidebar-section">
                    <h4>üé® Appearance</h4>
                    <button id="sidebar-theme" class="sidebar-btn">
                        <i class="fas fa-palette"></i> Change Theme
                    </button>
                </div>
                <div class="sidebar-section">
                    <h4>üöÄ Categories</h4>
                    <button class="sidebar-btn emoji-filter" data-filter="all">
                        üìã All Notes
                    </button>
                    <button class="sidebar-btn emoji-filter" data-filter="idea">
                        üí° Ideas
                    </button>
                    <button class="sidebar-btn emoji-filter" data-filter="task">
                        ‚úÖ Tasks
                    </button>
                    <button class="sidebar-btn emoji-filter" data-filter="meeting">
                        üìπ Meetings
                    </button>
                    <button class="sidebar-btn emoji-filter" data-filter="personal">
                        ‚ù§Ô∏è Personal
                    </button>
                </div>
                <div class="sidebar-section book-categories" style="display: none;">
                    <h4>üìö Book Categories</h4>
                    <button class="sidebar-btn book-filter" data-status="all">
                        üìö All Books
                    </button>
                    <button class="sidebar-btn book-filter" data-status="reading">
                        üìñ Currently Reading
                    </button>
                    <button class="sidebar-btn book-filter" data-status="completed">
                        ‚úÖ Completed
                    </button>
                    <button class="sidebar-btn book-filter" data-status="paused">
                        ‚è∏Ô∏è Paused
                    </button>
                </div>
                <div class="sidebar-section highlight-categories" style="display: none;">
                    <h4>üé® Highlight Colors</h4>
                    <button class="sidebar-btn highlight-filter" data-color="all">
                        üåà All Highlights
                    </button>
                    <button class="sidebar-btn highlight-filter" data-color="yellow">
                        üü° Key Concepts
                    </button>
                    <button class="sidebar-btn highlight-filter" data-color="green">
                        üü¢ Actionable Insights
                    </button>
                    <button class="sidebar-btn highlight-filter" data-color="blue">
                        üîµ Memorable Quotes
                    </button>
                    <button class="sidebar-btn highlight-filter" data-color="orange">
                        üü† Questions
                    </button>
                    <button class="sidebar-btn highlight-filter" data-color="red">
                        üî¥ Critical Points
                    </button>
                </div>
            </div>
        </div>
        <div id="sidebar-overlay" class="sidebar-overlay"></div>

        <div class="notes-list" id="notes-list" style="display: none;">
            <div class="list-header">
                <h2><i class="fas fa-sticky-note"></i> Your Notes <span id="notes-count">(0)</span></h2>
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-notes" placeholder="Find your notes...">
                </div>
            </div>
            <div class="notes-container" id="notes-container"></div>
        </div>

        <!-- Books Library Section -->
        <div class="books-list" id="books-list">
            <div class="list-header">
                <h2><i class="fas fa-book"></i> Your Books <span id="books-count">(0)</span></h2>
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-books" placeholder="Find your books...">
                </div>
                <div class="view-controls">
                    <button id="books-grid-view" class="view-btn active" title="Grid View">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button id="books-list-view" class="view-btn" title="List View">
                        <i class="fas fa-list"></i>
                    </button>
                    <button id="add-book-btn" class="btn primary">
                        <i class="fas fa-plus"></i> Add Book
                    </button>
                </div>
            </div>
            <div class="books-container" id="books-container"></div>
        </div>

        <!-- Highlights Section -->
        <div class="highlights-list" id="highlights-list" style="display: none;">
            <div class="list-header">
                <h2><i class="fas fa-highlighter"></i> Your Highlights <span id="highlights-count">(0)</span></h2>
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-highlights" placeholder="Find in highlights...">
                </div>
                <div class="highlight-filters">
                    <button class="highlight-color-btn active" data-color="all" title="All">
                        <i class="fas fa-rainbow"></i>
                    </button>
                    <button class="highlight-color-btn" data-color="yellow" title="Key Concepts">
                        <span class="color-dot yellow"></span>
                    </button>
                    <button class="highlight-color-btn" data-color="green" title="Actionable">
                        <span class="color-dot green"></span>
                    </button>
                    <button class="highlight-color-btn" data-color="blue" title="Quotes">
                        <span class="color-dot blue"></span>
                    </button>
                    <button class="highlight-color-btn" data-color="orange" title="Questions">
                        <span class="color-dot orange"></span>
                    </button>
                    <button class="highlight-color-btn" data-color="red" title="Critical">
                        <span class="color-dot red"></span>
                    </button>
                </div>
            </div>
            <div class="highlights-container" id="highlights-container"></div>
        </div>
    </div>

    <!-- Modal Structure -->
    <div id="note-modal" class="modal-container">
        <div class="modal-overlay" id="modal-overlay"></div>
        <div class="modal-content">
            <div class="editor">
                <!-- STYLING FIX: New wrapper for the entire header row -->
                <div class="editor-main-header">
                    <div class="editor-header">
                        <div class="note-tags">
                            <span class="tag" data-tag="idea"><i class="fas fa-lightbulb"></i> Idea</span>
                            <span class="tag" data-tag="task"><i class="fas fa-tasks"></i> Task</span>
                            <span class="tag" data-tag="meeting"><i class="fas fa-video"></i> Meeting</span>
                            <span class="tag" data-tag="personal"><i class="fas fa-heart"></i> Personal</span>
                        </div>
                        <div id="emoji-picker-container" class="header-actions">
                             <button id="emoji-picker-btn" class="icon-btn" title="Insert emoji">
                                <i class="far fa-smile"></i>
                            </button>
                            <div id="emoji-picker" class="emoji-picker">
                                <div class="emoji-search">
                                    <input type="text" id="emoji-search-input" placeholder="Search emojis..." />
                                </div>
                                <div class="emoji-tabs">
                                    <button class="emoji-tab active" data-category="recent">üïí</button>
                                    <button class="emoji-tab" data-category="smileys">üòä</button>
                                    <button class="emoji-tab" data-category="people">üëã</button>
                                    <button class="emoji-tab" data-category="nature">üåø</button>
                                    <button class="emoji-tab" data-category="food">üçï</button>
                                    <button class="emoji-tab" data-category="activities">‚öΩ</button>
                                    <button class="emoji-tab" data-category="objects">üì±</button>
                                    <button class="emoji-tab" data-category="symbols">üí°</button>
                                </div>
                                <div id="emoji-content" class="emoji-content">
                                    <!-- Dynamic content will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- MOVED: Close button is now a flex item within the new header -->
                    <button id="close-modal-btn" class="icon-btn modal-close-btn" title="Close editor"><i class="fas fa-times"></i></button>
                </div>
                
                <input type="text" id="note-title" placeholder="‚ú® Give your note a catchy title..." class="title-input">
                <div class="editor-toolbar">
                    <button class="tool-btn" data-action="bold"><i class="fas fa-bold"></i></button>
                    <button class="tool-btn" data-action="italic"><i class="fas fa-italic"></i></button>
                    <button class="tool-btn" data-action="underline"><i class="fas fa-underline"></i></button>
                    <button class="tool-btn" data-action="strikethrough"><i class="fas fa-strikethrough"></i></button>
                    <button class="tool-btn" data-action="bullet"><i class="fas fa-list-ul"></i></button>
                </div>
                <div id="note-content" contenteditable="true" class="content-input"></div>
                
                <div class="button-group">
                    <button id="save-note" class="btn primary"><i class="fas fa-save"></i> Save & Close</button>
                    <button id="delete-note" class="btn danger"><i class="fas fa-trash"></i> Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Book Import Modal -->
    <div id="book-import-modal" class="modal-container">
        <div class="modal-overlay"></div>
        <div class="modal-content book-import-content">
            <div class="modal-header">
                <h3><i class="fas fa-book-open"></i> Add New Book</h3>
                <button class="icon-btn modal-close-btn" onclick="closeBookImportModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="import-methods">
                <div class="import-method active" data-method="text">
                    <i class="fas fa-keyboard"></i>
                    <span>Type/Paste Text</span>
                </div>
                <div class="import-method" data-method="file">
                    <i class="fas fa-file-upload"></i>
                    <span>Upload File</span>
                </div>
                <div class="import-method" data-method="manual">
                    <i class="fas fa-edit"></i>
                    <span>Manual Entry</span>
                </div>
            </div>
            <div class="import-content">
                <!-- Text Input Method -->
                <div id="text-import" class="import-panel active">
                    <div class="form-group">
                        <label for="book-title-input">Book Title *</label>
                        <input type="text" id="book-title-input" placeholder="Enter book title..." required>
                    </div>
                    <div class="form-group">
                        <label for="book-author-input">Author</label>
                        <input type="text" id="book-author-input" placeholder="Author name...">
                    </div>
                    <div class="form-group">
                        <label for="book-category-select">Category</label>
                        <select id="book-category-select">
                            <option value="fiction">Fiction</option>
                            <option value="non-fiction">Non-Fiction</option>
                            <option value="self-help">Self-Help</option>
                            <option value="technical">Technical</option>
                            <option value="biography">Biography</option>
                            <option value="business">Business</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="book-content-input">Book Content *</label>
                        <textarea id="book-content-input" placeholder="Paste your book content here..." rows="12" required></textarea>
                    </div>
                </div>
                <!-- File Upload Method -->
                <div id="file-import" class="import-panel">
                    <div class="file-drop-zone" id="file-drop-zone">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Drop a text file here or <button type="button" onclick="document.getElementById('file-input').click()">browse files</button></p>
                        <input type="file" id="file-input" accept=".txt,.md" style="display: none;">
                    </div>
                    <div class="file-info" id="file-info" style="display: none;">
                        <p>File selected: <span id="file-name"></span></p>
                        <button type="button" onclick="clearFileSelection()">Clear</button>
                    </div>
                </div>
                <!-- Manual Entry Method -->
                <div id="manual-import" class="import-panel">
                    <div class="form-group">
                        <label for="manual-book-title">Book Title *</label>
                        <input type="text" id="manual-book-title" placeholder="Enter book title..." required>
                    </div>
                    <div class="form-group">
                        <label for="manual-book-author">Author</label>
                        <input type="text" id="manual-book-author" placeholder="Author name...">
                    </div>
                    <div class="form-group">
                        <label for="manual-book-isbn">ISBN (Optional)</label>
                        <input type="text" id="manual-book-isbn" placeholder="978-0000000000">
                    </div>
                    <div class="form-group">
                        <label for="manual-book-category">Category</label>
                        <select id="manual-book-category">
                            <option value="fiction">Fiction</option>
                            <option value="non-fiction">Non-Fiction</option>
                            <option value="self-help">Self-Help</option>
                            <option value="technical">Technical</option>
                            <option value="biography">Biography</option>
                            <option value="business">Business</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="manual-total-pages">Total Pages (Optional)</label>
                        <input type="number" id="manual-total-pages" placeholder="0">
                    </div>
                    <div class="note-info">
                        <i class="fas fa-info-circle"></i>
                        <p>You can add content later or start reading immediately.</p>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn secondary" onclick="closeBookImportModal()">Cancel</button>
                <button class="btn primary" id="save-book-btn">
                    <i class="fas fa-save"></i> Save Book
                </button>
            </div>
        </div>
    </div>

    <!-- Book Reader Modal -->
    <div id="book-reader-modal" class="modal-container full-screen">
        <div class="modal-overlay"></div>
        <div class="modal-content reader-content">
            <div class="reader-header">
                <div class="reader-info">
                    <h3 id="reader-book-title">Book Title</h3>
                    <p id="reader-book-author">Author Name</p>
                </div>
                
                <!-- Mobile Reader Menu Button -->
                <button id="reader-mobile-menu-btn" class="icon-btn reader-mobile-menu-btn" title="Reader Menu">
                    <i class="fas fa-bars"></i>
                </button>
                
                <!-- Desktop Reader Controls -->
                <div class="reader-controls desktop-reader-controls">
                    <button class="icon-btn" id="reader-bookmark-btn" title="Add Bookmark">
                        <i class="fas fa-bookmark"></i>
                    </button>
                    <button class="icon-btn" id="reader-settings-btn" title="Reading Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="icon-btn" id="reader-highlights-btn" title="Toggle Highlights Panel">
                        <i class="fas fa-highlighter"></i>
                    </button>
                    <button class="icon-btn" id="reader-notes-btn" title="Toggle Notes Panel">
                        <i class="fas fa-sticky-note"></i>
                    </button>
                    <button class="icon-btn" onclick="closeBookReader()" title="Close Reader">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Reader Sidebar Menu -->
            <div id="reader-mobile-sidebar" class="reader-mobile-sidebar">
                <div class="reader-sidebar-header">
                    <h3><i class="fas fa-book-open"></i> Reader Menu</h3>
                    <button id="close-reader-sidebar-btn" class="icon-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="reader-sidebar-content">
                    <div class="reader-sidebar-section">
                        <h4><i class="fas fa-tools"></i> Reading Tools</h4>
                        <button id="sidebar-reader-bookmark" class="sidebar-btn reader-action-btn" data-action="bookmark">
                            <i class="fas fa-bookmark"></i> Add Bookmark
                        </button>
                        <button id="sidebar-reader-settings" class="sidebar-btn reader-action-btn" data-action="settings">
                            <i class="fas fa-cog"></i> Reading Settings
                        </button>
                    </div>
                    <div class="reader-sidebar-section">
                        <h4><i class="fas fa-eye"></i> View Options</h4>
                        <button id="sidebar-reader-highlights" class="sidebar-btn reader-action-btn" data-action="highlights">
                            <i class="fas fa-highlighter"></i> Toggle Highlights
                        </button>
                        <button id="sidebar-reader-notes" class="sidebar-btn reader-action-btn" data-action="notes">
                            <i class="fas fa-sticky-note"></i> Toggle Notes
                        </button>
                    </div>
                    <div class="reader-sidebar-section">
                        <h4><i class="fas fa-palette"></i> Appearance</h4>
                        <button id="sidebar-reader-theme" class="sidebar-btn reader-action-btn" data-action="theme">
                            <i class="fas fa-palette"></i> Change Theme
                        </button>
                    </div>
                    <div class="reader-sidebar-section">
                        <h4><i class="fas fa-sign-out-alt"></i> Navigation</h4>
                        <button id="sidebar-reader-close" class="sidebar-btn reader-action-btn danger" data-action="close">
                            <i class="fas fa-times"></i> Close Reader
                        </button>
                    </div>
                </div>
            </div>
            <div id="reader-sidebar-overlay" class="reader-sidebar-overlay"></div>
            <div class="reader-body">
                <div class="reader-main">
                    <div class="reading-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="reading-progress-fill"></div>
                        </div>
                        <span class="progress-text" id="reading-progress-text">0%</span>
                    </div>
                    <div class="reader-content-area" id="reader-content-area">
                        <!-- Book content will be loaded here -->
                    </div>
                </div>
                <div class="reader-sidebar" id="reader-sidebar">
                    <div class="sidebar-tabs">
                        <button class="sidebar-tab active" data-tab="highlights">
                            <i class="fas fa-highlighter"></i> Highlights
                        </button>
                        <button class="sidebar-tab" data-tab="notes">
                            <i class="fas fa-sticky-note"></i> Notes
                        </button>
                    </div>
                    <div class="sidebar-content">
                        <div id="highlights-panel" class="sidebar-panel active">
                            <!-- Highlights will be loaded here -->
                        </div>
                        <div id="notes-panel" class="sidebar-panel">
                            <!-- Notes will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- Floating Highlight Toolbar -->
            <div class="highlight-toolbar" id="highlight-toolbar" style="display: none;">
                <button class="highlight-btn" data-color="yellow" title="Key Concept">
                    <span class="color-dot yellow"></span>
                </button>
                <button class="highlight-btn" data-color="green" title="Actionable Insight">
                    <span class="color-dot green"></span>
                </button>
                <button class="highlight-btn" data-color="blue" title="Memorable Quote">
                    <span class="color-dot blue"></span>
                </button>
                <button class="highlight-btn" data-color="orange" title="Question">
                    <span class="color-dot orange"></span>
                </button>
                <button class="highlight-btn" data-color="red" title="Critical Point">
                    <span class="color-dot red"></span>
                </button>
                <button class="highlight-btn" id="add-note-to-highlight" title="Add Note">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="highlight-btn" id="remove-highlight" title="Remove Highlight">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="floating-action" id="floating-new-note">
        <i class="fas fa-plus"></i>
    </div>

    <script src="script.js"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Simple service worker registration - main update logic is in script.js
        let refreshing = false;
        let newWorkerAvailable = null;
        
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('SW registered: ', registration);
                    
                    // Handle service worker updates with automatic refresh
                    registration.addEventListener('updatefound', () => {
                        newWorkerAvailable = registration.installing;
                        
                        if (newWorkerAvailable) {
                            newWorkerAvailable.addEventListener('statechange', () => {
                                switch (newWorkerAvailable.state) {
                                    case 'installed':
                                        if (navigator.serviceWorker.controller) {
                                            // New content is available, show toast and auto-refresh
                                            if (typeof showToast === 'function') {
                                                showToast('üîÑ App updated! Refreshing automatically...', 'info');
                                            }
                                            
                                            // Auto-refresh after 2 seconds
                                            setTimeout(() => {
                                                refreshAppNow();
                                            }, 2000);
                                        } else {
                                            // No controller means first install
                                            if (typeof showToast === 'function') {
                                                showToast('‚úÖ App ready for offline use!', 'success');
                                            }
                                        }
                                        break;
                                        
                                    case 'redundant':
                                        console.log('New service worker is redundant');
                                        break;
                                }
                            });
                        }
                    });
                    
                    // Listen for controlling service worker changes
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        if (refreshing) return;
                        refreshing = true;
                        window.location.reload();
                    });
                    
                } catch (error) {
                    console.log('SW registration failed: ', error);
                }
            });
        }
        
        // Function to refresh the app (renamed to avoid conflicts)
        function refreshAppNow() {
            if (newWorkerAvailable) {
                newWorkerAvailable.postMessage({ type: 'SKIP_WAITING' });
            } else {
                window.location.reload();
            }
        }
        
        // Handle service worker messages
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                console.log('Message from SW:', event.data);
                
                if (event.data && event.data.type === 'SYNC_COMPLETE') {
                    if (typeof showToast === 'function') {
                        showToast('üìö Data synced successfully!', 'success');
                    }
                }
                
                if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
                    if (typeof showToast === 'function') {
                        showToast('üîÑ New version available! Updating...', 'info');
                    }
                    setTimeout(() => refreshAppNow(), 1500);
                }
            });
        }
    </script>
</body>
</html>